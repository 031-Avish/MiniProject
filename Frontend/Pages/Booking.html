<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Booking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="../Css/Home.css">
    <link rel="stylesheet" href="../Css/Navbar.css">
    <style>
        .each-flight-div {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
        }

        .each-flight-div-box {
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, .1);
            margin-top: 10px;
        }

        .card {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, .125);
            border-top-left-radius: 0px;
            border-top-right-radius: 0px;
        }

        .each-flight-div>div {
            display: flex;
        }

        .company-details {
            padding-left: 5px;
            padding-right: 5px;
        }

        .company-name {
            font-weight: bold;
        }

        .plane-name {
            font-size: .8em;
            color: rgb(97, 97, 97);
        }

        .flight-company {
            width: 25%;
        }

        .flight-time {
            display: flex;
            justify-content: space-evenly;
            flex: 1;
        }

        .flight-details {
            width: 32%;
            justify-content: space-between;
        }

        .flight-origin-time,
        .flight-destination-time {
            width: 40%;
        }

        .flight-stops {
            width: 20%;
            display: flex;
            justify-content: center;
        }

        .flight-time h5 {
            margin-bottom: 2px;
        }

        .flight-place {
            font-size: .8em;
            color: grey;
            text-align: center;
        }

        .each-flight-div>div {
            display: flex;
            margin-top: auto;
            margin-bottom: auto;
        }

        .flight-price {
            display: flex;
            margin-right: 15px;
        }

        .flight-price>h5 {
            margin-top: 20%;
            margin-bottom: 20%;
            font-weight: 600;
        }

        .flight-stops {
            position: relative;
            opacity: 1;
        }
        .flight-preview {
            display: flex;
            justify-content: space-between;
            margin: 0 10%;
            flex-wrap: wrap;
        }
        #flightResults {
            width: 600px;
        }
        .price {
            Border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, .1);
            margin-top: 10px;
            width: 300px;
            height: 80px;
        }
        .static-data {
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, .1);
            margin: 0 10%;
            /* margin: auto;        */
            margin-top: 20px;
            margin-right: 20px;
        }
        .static-contain {
            
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        @media (max-width: 768px) {
            .static-contain{
                flex-direction: column;
                margin-left: 10px;
                margin-right: 10px;
            }
        }
    </style>
</head>
<body style="margin-top: 60px;">
    <!-- Main Content -->
    <h2 class="text-center">Flight Preview</h2>
    <div class="flight-preview">
        <div id="flightResults">
          <!-- Flight results will be dynamically inserted here -->
        </div>
        <div class="price">
            <h4 class="text-center">Total Price</h4>
            <h4 class="text-center" id="totalPrice"></h4>
        </div>
    </div>

    <div class="insurance-container">
        <div
          class="m-0 mt-0 mb-0 ml-0 mr-0 mx-0 my-0 mt-8"
          style="height: 1px; width: 1px"
        >
        </div>
        <div class="container static-data">
          <div class="row">
            <div class="col-24 pl-0 pr-0">
              <div
                class="flex flex-between ba btr-4 bg-secondary-100 ba bc-secondary-100 h-12"
              >
                <div class="flex flex-middle ml-5 flex-1">
                  <div class="fs-4 c-neutral-900 fw-700 lh-title" style="    font-size: 1.5rem;
    font-weight: 500;">
                    Some Standard fare Details
                  </div>
                </div>
              </div>
              <div
                class="bl br bc-neutral-100 px-5 pt-4 flex flex-column flex-between"
              >
                <div class="flex flex-between static-contain ">
                  
                    <div class="mb-4 p-2 d-flex flex-bottom">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <rect width="16" height="16" fill="none"></rect>
                        <path
                          d="M8.00033 10.3001L6.70033 11.6001C6.64477 11.6668 6.56988 11.7028 6.47566 11.7081C6.38099 11.7139 6.30033 11.6779 6.23366 11.6001C6.15588 11.5334 6.11699 11.4557 6.11699 11.3668C6.11699 11.2779 6.15588 11.2001 6.23366 11.1334L7.53366 9.83343L6.23366 8.53343C6.16699 8.47788 6.13099 8.40276 6.12566 8.3081C6.11988 8.21388 6.15588 8.13343 6.23366 8.06676C6.30033 7.98899 6.3781 7.9501 6.46699 7.9501C6.55588 7.9501 6.63366 7.98899 6.70033 8.06676L8.00033 9.36676L9.30033 8.06676C9.35588 8.0001 9.43099 7.9641 9.52566 7.95876C9.61988 7.95299 9.70033 7.98899 9.76699 8.06676C9.84477 8.13343 9.88366 8.21121 9.88366 8.3001C9.88366 8.38899 9.84477 8.46676 9.76699 8.53343L8.46699 9.83343L9.76699 11.1334C9.83366 11.189 9.86966 11.2641 9.87499 11.3588C9.88077 11.453 9.84477 11.5334 9.76699 11.6001C9.70033 11.6779 9.62255 11.7168 9.53366 11.7168C9.44477 11.7168 9.36699 11.6779 9.30033 11.6001L8.00033 10.3001ZM3.75033 14.0001C3.43921 14.0001 3.18099 13.8974 2.97566 13.6921C2.76988 13.4863 2.66699 13.2279 2.66699 12.9168V4.41676C2.66699 4.10565 2.76988 3.84743 2.97566 3.6421C3.18099 3.43632 3.43921 3.33343 3.75033 3.33343H4.91699V2.2001C4.91699 2.1001 4.95299 2.01676 5.02499 1.9501C5.09744 1.88343 5.18366 1.8501 5.28366 1.8501C5.38366 1.8501 5.46699 1.88343 5.53366 1.9501C5.60033 2.01676 5.63366 2.1001 5.63366 2.2001V3.33343H10.417V2.18343C10.417 2.08343 10.4474 2.00276 10.5083 1.94143C10.5697 1.88054 10.6503 1.8501 10.7503 1.8501C10.8392 1.8501 10.917 1.88054 10.9837 1.94143C11.0503 2.00276 11.0837 2.08343 11.0837 2.18343V3.33343H12.2503C12.5614 3.33343 12.8199 3.43632 13.0257 3.6421C13.231 3.84743 13.3337 4.10565 13.3337 4.41676V12.9168C13.3337 13.2279 13.231 13.4863 13.0257 13.6921C12.8199 13.8974 12.5614 14.0001 12.2503 14.0001H3.75033ZM3.75033 13.3334H12.2503C12.3725 13.3334 12.4725 13.2945 12.5503 13.2168C12.6281 13.139 12.667 13.039 12.667 12.9168V7.08343H3.33366V12.9168C3.33366 13.039 3.37255 13.139 3.45033 13.2168C3.5281 13.2945 3.6281 13.3334 3.75033 13.3334ZM3.33366 6.41676H12.667V4.41676C12.667 4.29454 12.6281 4.19454 12.5503 4.11676C12.4725 4.03899 12.3725 4.0001 12.2503 4.0001H3.75033C3.6281 4.0001 3.5281 4.03899 3.45033 4.11676C3.37255 4.19454 3.33366 4.29454 3.33366 4.41676V6.41676Z"
                          fill="#1A1A1A"
                        ></path>
                      </svg>
                      <div class="fs-2 c-grey-70 ml-2">
                        Cancellation fee min 25% of fare
                      </div>
                    </div>
                   
               
                    <div class="mb-4 p-2  d-flex flex-bottom">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <rect width="16" height="16" fill="none"></rect>
                        <path
                          d="M9.44306 3.21053C9.44306 2.54197 8.90109 2 8.23253 2C7.56398 2 7.02201 2.54197 7.02201 3.21053M11.8641 12.2895C12.1984 12.2895 12.4694 12.0185 12.4694 11.6842V9.26316C12.4694 8.92888 12.1984 8.65789 11.8641 8.65789M4.62931 8.65801C4.29486 8.65539 4.02161 8.92424 4.01899 9.25851L4.00002 11.6795C3.9974 12.0138 4.2664 12.2869 4.60086 12.2895M10.6536 13.5V11.6842C10.6536 10.3471 9.56964 9.26316 8.23253 9.26316C6.89542 9.26316 5.81148 10.3471 5.81148 11.6842V13.5H10.6536ZM8.23253 3.21053C10.2382 3.21053 11.8641 4.83644 11.8641 6.84211V12.6842C11.8641 13.1348 11.4989 13.5 11.0483 13.5H5.41674C4.9662 13.5 4.60096 13.1348 4.60096 12.6842V6.84211C4.60096 4.83644 6.22687 3.21053 8.23253 3.21053ZM7.32938 6.84211H9.14517C9.47944 6.84211 9.75043 6.57112 9.75043 6.23684C9.75043 5.90256 9.47944 5.63158 9.14517 5.63158H7.32938C6.9951 5.63158 6.72411 5.90256 6.72411 6.23684C6.72411 6.57112 6.9951 6.84211 7.32938 6.84211Z"
                          stroke="#1A1A1A"
                          stroke-width="0.7"
                        ></path>
                      </svg>
                      <div class="fs-2 c-grey-70 ml-2">Cabin/person: 7kg</div>
                    </div>
                    <div class="mb-4 p-2 d-flex flex-bottom">
                      <svg width="16" height="16" viewBox="0 0 16 16">
                        <g fill="none" fill-rule="evenodd">
                          <path d="M0 0h16v16H0z"></path>
                          <path
                            d="M.667 14.653c0 .374.3.674.673.674H10c.373 0 .673-.3.673-.674V14H.667v.653zm5-8.66c-2.5 0-5 1.34-5 4.007h10c0-2.667-2.5-4.007-5-4.007zM2.413 8.667c.74-1.034 2.314-1.34 3.254-1.34s2.513.306 3.253 1.34H2.413zM.667 11.333h10v1.334h-10v-1.334zm11.333-8V.667h-1.333v2.666H7.333l.154 1.334h6.373L12.927 14H12v1.333h1.147c.56 0 1.02-.433 1.086-.98l1.1-11.02H12z"
                            fill="#4D4D4D"
                            fill-rule="nonzero"
                          ></path>
                        </g>
                      </svg>
                      <div class="fs-2 c-grey-70 ml-2">Paid meal</div>
                    </div>
                    <div class="mb-4 p-2 d-flex flex-bottom">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <rect width="16" height="16" fill="none"></rect>
                        <path
                          d="M5.08333 13.3333C4.78333 13.3333 4.52778 13.2277 4.31667 13.0166C4.10556 12.8055 4 12.55 4 12.25V5.66663C4 5.38886 4.09733 5.15286 4.292 4.95863C4.48622 4.76397 4.72222 4.66663 5 4.66663H6.33333V2.91663C6.33333 2.77219 6.38333 2.64708 6.48333 2.5413C6.58333 2.43597 6.71667 2.3833 6.88333 2.3833H9.11667C9.28333 2.3833 9.41667 2.43597 9.51667 2.5413C9.61667 2.64708 9.66667 2.77219 9.66667 2.91663V4.66663H10.9167C11.2167 4.66663 11.4722 4.77219 11.6833 4.9833C11.8944 5.19441 12 5.44997 12 5.74997V12.25C12 12.55 11.8944 12.8055 11.6833 13.0166C11.4722 13.2277 11.2167 13.3333 10.9167 13.3333C10.9167 13.4777 10.8696 13.6 10.7753 13.7C10.6807 13.8 10.5611 13.85 10.4167 13.85C10.2611 13.85 10.136 13.8 10.0413 13.7C9.94711 13.6 9.9 13.4777 9.9 13.3333H6.1C6.1 13.4777 6.05 13.6 5.95 13.7C5.85 13.8 5.72778 13.85 5.58333 13.85C5.43889 13.85 5.31956 13.8 5.22533 13.7C5.13067 13.6 5.08333 13.4777 5.08333 13.3333ZM6.91667 4.66663H9.08333V2.96663H6.91667V4.66663ZM5.08333 12.6666H10.9167C11.0389 12.6666 11.1389 12.6277 11.2167 12.55C11.2944 12.4722 11.3333 12.3722 11.3333 12.25V5.74997C11.3333 5.62775 11.2944 5.52775 11.2167 5.44997C11.1389 5.37219 11.0389 5.3333 10.9167 5.3333H5.08333C4.96111 5.3333 4.86111 5.37219 4.78333 5.44997C4.70556 5.52775 4.66667 5.62775 4.66667 5.74997V12.25C4.66667 12.3722 4.70556 12.4722 4.78333 12.55C4.86111 12.6277 4.96111 12.6666 5.08333 12.6666ZM5.53333 11.3666C5.53333 11.4555 5.56111 11.5277 5.61667 11.5833C5.67222 11.6389 5.74444 11.6666 5.83333 11.6666C5.92222 11.6666 5.99444 11.6389 6.05 11.5833C6.10556 11.5277 6.13333 11.4555 6.13333 11.3666V6.6333C6.13333 6.54441 6.10556 6.47219 6.05 6.41663C5.99444 6.36108 5.92222 6.3333 5.83333 6.3333C5.74444 6.3333 5.67222 6.36108 5.61667 6.41663C5.56111 6.47219 5.53333 6.54441 5.53333 6.6333V11.3666ZM7.7 11.3666C7.7 11.4555 7.72778 11.5277 7.78333 11.5833C7.83889 11.6389 7.91111 11.6666 8 11.6666C8.08889 11.6666 8.16111 11.6389 8.21667 11.5833C8.27222 11.5277 8.3 11.4555 8.3 11.3666V6.6333C8.3 6.54441 8.27222 6.47219 8.21667 6.41663C8.16111 6.36108 8.08889 6.3333 8 6.3333C7.91111 6.3333 7.83889 6.36108 7.78333 6.41663C7.72778 6.47219 7.7 6.54441 7.7 6.6333V11.3666ZM9.86667 11.3666C9.86667 11.4555 9.89444 11.5277 9.95 11.5833C10.0056 11.6389 10.0778 11.6666 10.1667 11.6666C10.2556 11.6666 10.3278 11.6389 10.3833 11.5833C10.4389 11.5277 10.4667 11.4555 10.4667 11.3666V6.6333C10.4667 6.54441 10.4389 6.47219 10.3833 6.41663C10.3278 6.36108 10.2556 6.3333 10.1667 6.3333C10.0778 6.3333 10.0056 6.36108 9.95 6.41663C9.89444 6.47219 9.86667 6.54441 9.86667 6.6333V11.3666Z"
                          fill="#1C1B1F"
                        ></path>
                      </svg>
                      <div class="fs-2 c-grey-70 ml-2">Check-in/person: 15kg</div>
                  </div>
                
              </div>
            </div>
        </div>
        </div>
    </div>
    <div class="container mt-3 ">
        <div class="row ml-3">
            <div class="col-md-12">
                <div id="passenger-section">
                    <h3 class="">Add Passengers</h3>
                    <form id="passenger-form">
                        <div id="passenger-list">
                            <!-- Passenger input fields will be dynamically inserted here -->
                        </div>
                        <button type="button" class="btn btn-primary" id="add-passenger-btn">+ Add Passenger</button>
                    </form>
                </div>
                <button type="button" class="btn btn-success mt-3" id="book-ticket-btn">Book Ticket With Payment</button>
                <div id="booking-preview" class="mt-3" style="display:none;">
                    <h3 class="text-center">Booking Preview</h3>
                    <div id="booking-details">
                        <!-- Booking details will be dynamically inserted here -->
                    </div>
                    <!-- <button type="button" class="btn btn-success mt-3" id="make-payment-btn">Make Payment</button> -->
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade alertModel" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header" id="modal-header">
              <h5 class="modal-title" id="exampleModalLabel"></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="model-content">
              
            </div>
          </div>
        </div>
      </div>
    <!-- Custom Script -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const scheduleId = parseInt(urlParams.get('scheduleId'));
            const scheduleId1 = parseInt(urlParams.get('scheduleId1'));
            console.log(scheduleId);
            console.log(scheduleId1);
            const userId = parseInt(localStorage.getItem('userId'));
            const token = localStorage.getItem('token');
            let flight=[];
            console.log(isNaN(scheduleId1));
            if(isNaN(scheduleId1)){
                flight.push(JSON.parse(localStorage.getItem('flight')));
            }else{
                flight=JSON.parse(localStorage.getItem('connectingflight'));
            }
            console.log(flight);
            displayFlightDetails(flight);
            let passengers = [];
            // Add passenger
            document.getElementById('add-passenger-btn').addEventListener('click', function() {
                const passengerList = document.getElementById('passenger-list');
                const passengerCount = passengerList.children.length + 1;
                const passengerDiv = document.createElement('div');
                passengerDiv.classList.add('form-group', 'passenger');
                passengerDiv.innerHTML = `
                    <h4>Passenger ${passengerCount}</h4>
                    <label for="passenger-name-${passengerCount}">Name:</label>
                    <input type="text" class="form-control" id="passenger-name-${passengerCount}" required>
                    <label for="passenger-age-${passengerCount}">Age:</label>
                    <input type="number" class="form-control" id="passenger-age-${passengerCount}" required>
                    <label for="passenger-gender-${passengerCount}">Gender:</label>
                    <select class="form-control" id="passenger-gender-${passengerCount}" required>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <button type="button" class="btn btn-danger mt-2 remove-passenger-btn">Remove Passenger</button>
                `;
                passengerList.appendChild(passengerDiv);
                calculateTotalPrice();
                updateRemoveButtons();
            });
        function displayFlightDetails(data) {

            const flightResults = document.getElementById("flightResults");
            flightResults.innerHTML = "";
            data.forEach((flight) => {
            const flightCard = document.createElement("div");
            flightCard.classList.add("each-flight-div-box", "show");
          flightCard.innerHTML = `
            <div class="each-flight-div" onclick="media_click(this)">
                <div class="flight-company">
                    <div class="flight-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1.5em" height="1.3em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 440 384">
                            <path d="M14 335h405v43H14v-43zm417.5-199.5q3.5 12.5-3 24T409 175l-114 30l-92 25l-114 30l-34 10l-16-29l-39-67l31-9l42 33l106-28L91 17l41-11l147 137l113-30q13-4 24.5 3t15 19.5z" fill="#434445"/>
                            <rect x="0" y="0" width="440" height="384" fill="rgba(0, 0, 0, 0)"/>
                        </svg>
                    </div>
                    <div class="company-details">
                        <div class="company-name">${
                          flight.flightInfo.name
                        }</div>
                        
                    </div>
                </div>
                <div class="flight-time flight-time-div">
                    <div class="flight-origin-time">
                        <div class="flight-time">
                            <h5>${
                              new Date(flight.departureTime)
                                .toLocaleString()
                                .split(",")[1]
                            }</h5>
                        </div>
                        <div class="flight-place">
                            ${flight.routeInfo.startCity}
                        </div>
                    </div>
                    <div class="flight-stops tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="24" viewBox="0 0 24 24">
                            <path d="M13,9.03544443 C14.6961471,9.27805926 16,10.736764 16,12.5 C16,14.263236 14.6961471,15.7219407 13,15.9645556 L13,21.5207973 C13,21.7969397 12.7761424,22.0207973 12.5,22.0207973 C12.2238576,22.0207973 12,21.7969397 12,21.5207973 L12,15.9645556 C10.3038529,15.7219407 9,14.263236 9,12.5 C9,10.736764 10.3038529,9.27805926 12,9.03544443 L12,3.5 C12,3.22385763 12.2238576,3 12.5,3 C12.7761424,3 13,3.22385763 13,3.5 L13,9.03544443 L13,9.03544443 Z M12.5,15 C13.8807119,15 15,13.8807119 15,12.5 C15,11.1192881 13.8807119,10 12.5,10 C11.1192881,10 10,11.1192881 10,12.5 C10,13.8807119 11.1192881,15 12.5,15 Z" transform="rotate(90 12.5 12.51)"/>
                        </svg>
                        
                    </div>
                    <div class="flight-destination-time">
                        <div class="flight-time">
                            <h5>${
                              new Date(flight.reachingTime)
                                .toLocaleString()
                                .split(",")[1]
                            }</h5>
                        </div>
                        <div class="flight-place">
                            ${flight.routeInfo.endCity}
                        </div>
                    </div>
                </div>
              
            </div>
        `;
          flightResults.appendChild(flightCard);
        });
        }

            // Remove passenger
            document.addEventListener('click', function(event) {
                if (event.target && event.target.classList.contains('remove-passenger-btn')) {
                    event.target.closest('.passenger').remove();
                    calculateTotalPrice();
                    updateRemoveButtons();
                }
            });

            function updateRemoveButtons() {
                const removeButtons = document.querySelectorAll('.remove-passenger-btn');
                if (removeButtons.length === 0) {
                    document.getElementById('add-passenger-btn').disabled = false;
                } else {
                    document.getElementById('add-passenger-btn').disabled = false;
                }
            }

            function calculateTotalPrice(){
                const passengerList = document.getElementById('passenger-list');
                if(passengerList.children.length===0){
                    document.getElementById('totalPrice').innerHTML=0;
                    return;
                }
                if(flight.length===1){
                    document.getElementById('totalPrice').
                    innerHTML=`${passengerList.children.length*flight[0].price}`;
                }else{
                    document.getElementById('totalPrice').
                    innerHTML=`${passengerList.children.length*(flight[0].price+flight[1].price)}`;
                }
            }

            // Book ticket
            document.getElementById('book-ticket-btn').addEventListener('click', async function() {
                const passengerList = document.getElementById('passenger-list');
                passengers = [];
                for (let i = 0; i < passengerList.children.length; i++) {
                    const passengerDiv = passengerList.children[i];
                    const name = passengerDiv.querySelector(`#passenger-name-${i + 1}`).value;
                    const age = passengerDiv.querySelector(`#passenger-age-${i + 1}`).value;
                    const gender = passengerDiv.querySelector(`#passenger-gender-${i + 1}`).value;

                    if (!name || !age || !gender) {
                        showAlert('All passenger fields are required', 'danger');
                        return;
                    }

                    passengers.push({ name, age, gender });
                }

                if (passengers.length === 0) {
                    showAlert('At least one passenger is required', 'danger');
                    return;
                }
                // Check if there is any passenger whose age is more than 2
                const hasPassengerAboveAge2 = passengers.some(passenger => passenger.age > 10);

                if (!hasPassengerAboveAge2) {
                    showAlert('At least adult passenger is required','danger');
                    return;
                }
                console.log(scheduleId, userId, passengers);
                let bookingDetails = [];
                if(isNaN(scheduleId1)){
                    bookingDetails =[ {
                        scheduleId: scheduleId,
                        userId: userId,
                        passengers: passengers
                    }];

                }else{
                    bookingDetails =[{
                        scheduleId: scheduleId,
                        userId: userId,
                        passengers: passengers
                    },
                    {
                        scheduleId: scheduleId1,
                        userId: userId,
                        passengers: passengers
                    }];
                }
                let bookingData = [];
                fetch('https://localhost:7067/api/Booking/BookFlightByUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(bookingDetails)
                })
                .then(response => response.json())
                .then( (data) => {
                    if (data.errorCode) {
                        showAlert(data.errorMessage, "danger");
                    } else {
                        console.log(data);
                        showAlert('Booking Successful', 'success');
                        data.forEach( (booking)=>{
                             makePayment(booking.bookingId, booking.totalPrice);
                        });
                        setTimeout(() => {
                            window.location.href = `TicketPage.html?BookingId=${data[0].bookingId}&bookingId1=${data[1]?.bookingId}`;
                        }, 4000);
                        // window.location.href = `TicketPage.html?BookingId=${data[0].bookingId}&bookingId1=${data[1]?.bookingId}`;

                    }
                })
                .catch(error => {
                    if (error.errorMessage) {
                        showAlert(error.errorMessage, "danger");
                        setTimeout(() => {
                            window.location.href = `TicketPage.html?BookingId=${data[0].bookingId}&bookingId1=${data[1]?.bookingId}`;
                        }, 4000);
                        // window.location.href = `TicketPage.html?BookingId=${data[0].bookingId}&bookingId1=${data[1]?.bookingId}`;
                    } else {
                        showAlert('Some unwanted error occurred', 'danger');
                    }
                });
                
                
            });

            function showBookingPreview(data) {
                const bookingPreview = document.getElementById('booking-preview');
                const bookingDetailsDiv = document.getElementById('booking-details');
                bookingDetailsDiv.innerHTML = `
                    <p><strong>Booking ID:</strong> ${data[0].bookingId}</p>
                    <p><strong>Booking Status:</strong> ${data[0].bookingStatus}</p>
                    <p><strong>Booking Date:</strong> ${new Date(data[0].bookingDate).toLocaleString()}</p>
                    <p><strong>Payment Status:</strong> ${data[0].paymentStatus}</p>
                    <p><strong>Total Price:</strong> ${data[0].totalPrice}</p>
                    <h4>Flight Details</h4>
                    <p><strong>Departure Time:</strong> ${new Date(data[0].flightDetails.departureTime).toLocaleString()}</p>
                    <p><strong>Reaching Time:</strong> ${new Date(data[0].flightDetails.reachingTime).toLocaleString()}</p>
                    <h4>Passengers</h4>
                    ${data[0].passengers.map(passenger => `
                        <p><strong>Name:</strong> ${passenger.name}</p>
                        <p><strong>Age:</strong> ${passenger.age}</p>
                        <p><strong>Gender:</strong> ${passenger.gender}</p>
                    `).join('')}
                `;
                bookingPreview.style.display = 'block';
            }

            function makePayment(bookingId, totalPrice) {
                const paymentDetails = {
                    bookingId: bookingId,
                    amount: totalPrice
                };

                fetch('https://localhost:7067/api/Payment/ProcessPaymentByUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(paymentDetails)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.errorCode) {
                        showAlert(data.errorMessage, "danger");
                        throw data.errorMessage;
                        // window.location.href = `TicketPage.html?BookingId=${bookingId}`
                    }
                    else if (data.errors) {
                        showAlert('Some unwanted error occurred', 'danger');
                        throw data.errors;
                    } else {
                        showAlert('Payment Successful', 'success');
                        // window.location.href = `TicketPage.html?BookingId=${bookingId}`
                    }
                })
                .catch(error => {
                    showAlert('Error making payment !! Try Again', 'danger');
                    console.error('Error:', error);
                    throw error;
                });
            }

            function showAlert(message, type) {
            document.getElementById('model-content').innerHTML = message;
            if (type === 'danger') {
                document.getElementById('exampleModalLabel').innerHTML = 'Error!';
                document.getElementById('modal-header').classList.remove('bg-success');
                document.getElementById('modal-header').classList.add('bg-danger');
            } else {
                document.getElementById('exampleModalLabel').innerHTML = 'Success!';
                document.getElementById('modal-header').classList.remove('bg-danger');
                document.getElementById('modal-header').classList.add('bg-success');
            }
            $('.alertModel').modal('show');
            setTimeout(() => {
                $('.alertModel').modal('hide');
            }, 4000);
        }
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="../JavaScripts/UserNavbar.js"></script>
    <script src="../JavaScripts/Home.js"></script>
</body>
</html>
